<html>
<head><title>EveCM settings</title>
<script type="text/javascript">

function save_options() {
  localStorage["keyid"] = document.getElementById("kid").value;
  localStorage["vcode"] = document.getElementById("vcode").value;
  localStorage["characterid"] = document.getElementById("chars").children[document.getElementById("chars").selectedIndex].value;
  localStorage["charactername"] = document.getElementById("chars").children[document.getElementById("chars").selectedIndex].innerHTML;
  if (document.getElementById('seconds').checked == true) {
      localStorage['seconds'] = 1000;
  } else{
      localStorage['seconds'] = 60000;
  }

  var status = document.getElementById("status");
  status.innerHTML = "Options Saved.";
  setTimeout(function() {
    status.innerHTML = "";
  }, 750);
}

// Restores select box state to saved value from localStorage.
function restore_options() {
  var kid = localStorage["keyid"];
  var vcode = localStorage["vcode"];
  var characterID = localStorage["characterid"];
  var characterName = localStorage["charactername"];
  if (!kid || !vcode || !characterID || !characterName) {
    return;
  }
  document.getElementById("kid").value = kid;
  document.getElementById("vcode").value = vcode;
  var character = document.createElement("option");
  character.value = characterID;
  character.innerHTML = characterName;
  document.getElementById("chars").appendChild(character);
  if (localStorage['seconds'] == 1000) {
      document.getElementById('seconds').checked = true;
  }
  showSkillsStationsInfo();
}



function get_chars () {
var req = new XMLHttpRequest();

  var kid = document.getElementById("kid").value;
  var vcode = document.getElementById("vcode").value;
  document.getElementById("chars").innerHTML="";
  req.open("GET", "https://api.eveonline.com/account/APIKeyInfo.xml.aspx?"+"keyID="+kid+"&vCode="+vcode, true);
   req.onload = function(){
        var xml = req.responseXML;
        var chars = xml.getElementsByTagName('row');
	for (var i=0, row; row = chars[i]; i++) {
		var character = document.createElement("option");
		character.value = row.getAttribute("characterID");
                character.innerHTML = row.getAttribute("characterName");
		document.getElementById("chars").appendChild(character);
	}
    };

   req.send(null);

}

function updateSkillsStations () {
    var d = new Date();
    var skills = new XMLHttpRequest();
    var stations = new XMLHttpRequest();
    stations.open("GET", "https://api.eveonline.com/eve/ConquerableStationList.xml.aspx", true);
    skills.open("GET", "https://api.eveonline.com/eve/SkillTree.xml.aspx", true);
    stations.onload = function (){
        localStorage['conqStations'] = stations.responseText;
        localStorage['lastUpdate'] = d.toLocaleString();
        skills.send(null);
    }
    skills.onload = function (){
        localStorage['skills'] = skills.responseText;
        alert(localStorage['skills']);
        showSkillsStationsInfo();
    }
    stations.send(null);
}

function showSkillsStationsInfo() {
    if (localStorage['lastUpdate']!=='')  {
        document.getElementById('stationsskills').innerHTML = localStorage['lastUpdate'];
    }
}


</script>
</head>

<body onload="restore_options()">

Eve API key:<br>
<input type="text" id="kid" size="15"><br>
<input type="text" id="vcode" size="100"><br>
<select id="chars"></select><br>
<input type="checkbox" id="seconds"> Display seconds in tooltip count<br>
<button onclick="save_options()">Save</button>
<button onclick="get_chars()">Get</button>
<span id="status"></span><br>
Stations List and SkillTree last update: <span id="stationsskills">none</span> <button onclick="updateSkillsStations ()">Update</button><br>
</body>
</html>
